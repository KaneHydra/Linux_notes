---
id: "20240430"
aliases: []
tags: []
---

# 20240430

## 續上次的檔案權限

### chmod 指令

修改權限

```sh
# 多組 符號mode用`,`區隔
chmod [OPTION] ... MODE[,MODE] ... FILE ...
# 常用option
# -R 遞迴邊更
# -v verbose 顯示詳細資訊

# 範例: 擁有群組可讀可執行,其他人不可寫
chmod -v g=rx,o-w mydir

# 用數字
chmod [OPTION] ... OCTAL-MODE FILE ...
# 範例: 把 mydir 資料夾以及他的內容, 遞迴改權限爲750
# 不過通常不會這樣改, 因爲目錄一定要可執行, 其他檔案可能不用
chmod -R 750 mydir
```

`ug=rw` 一定是是指定檔案
因爲開啓目錄就是執行的意思
沒有執行權限的話目錄會開不起來

| OCT | mode | 讀  | 寫  | 執行 |
| --- | ---- | --- | --- | ---- |
| 7   | rwx  | 讀  | 寫  | 執行 |
| 6   | rw-  | 讀  | 寫  |      |
| 5   | r-x  | 讀  |     | 執行 |
| 4   | r--  | 讀  |     |      |
| 3   | -wx  |     | 寫  | 執行 |
| 2   | -w-  |     | 寫  |      |
| 1   | --x  |     |     | 執行 |
| 0   | ---  |     |     |      |

`chmod a+w mydir/`
如果把目錄設定爲每個人都可以執行or寫入,
他會變成綠色底色,警告你權限太寬鬆

如果把文件檔加上執行權限,他會變成綠色字
告訴你其實沒意義,會造成混淆
除非你是要把shell script加上執行權限那另當別論,就不要理他

第一個一定是7
常用目錄權限
目錄一定是奇數,因爲需要執行權限
777
755
733
711
預設是755

檔案預設是644

用oct下指令一定是3個數字
用2個或1個,他前面會自己補0

加上 -v 的時候,會看到權限邊更,
他會顯示4個數字,按照順序是
特殊,擁有者,群組,其他人

補充
遞迴修改目錄下面的指定檔案類型的權限,而不修改目錄的權限

```sh
# 方法1, 比如說改sh檔
find /path/to/directory -name "*.sh" -exec chmod [privilege] {} \;
# 把 [privilege] 改成你要的權限, 比如說 777
find /path/to/directory -name "*.sh" -exec chmod 777 {} \;
# 方法2
find /path/to/directory -name "*.sh" -print0 | xargs -r0 chmod [privilege]
# 把 [privilege] 改成你要的權限, 比如說 777
find /path/to/directory -name "*.sh" -print0 | xargs -r0 chmod 777
```

### chown 變更擁有者

```sh
chown [OPTION] ... [OWNER][:GROUP] FILE ...
# 常用option
# -R 遞迴邊更
# -v verbose 顯示詳細資訊

# 修改mydir的擁有者爲barry,擁有群組爲users
chown barry:users mydir
# 遞迴修改mydir的擁有群組爲barry
chown -R :barry mydir
```

一般帳號無法邊更owner部分

一般帳號可以邊更group
但是該帳號必須爲owner
並且只能邊更爲該帳號所屬的群組

用id指令檢查user所屬群組

```sh
id [USERNAME]
```

可以在這個檔案修改群組`/etc/group`

### chgrp 變更群組

```sh
chgrp [OPTION] ... GROUP FILE ...
# 常用option
# -R 遞迴邊更
# -v verbose 顯示詳細資訊
```

### 特殊權限

加上 -v 的時候,會看到權限邊更,
他會顯示4個數字,按照順序是
特殊,擁有者,群組,其他人
用ls查看時
如果在owner的x位置出現s或S, 稱爲 set UID (SUID)
如果在group的x位置出現s或S, 稱爲 set GID (SGID)
如果在other的x位置出現t或T, 稱爲 Sticky Bit

大寫S/T表示該位置不具備 x 權限
小寫s/t表示該位置具備 x 權限

| 權限位置          | oct | 特殊權限       | 使用場景                 |
| ----------------- | --- | -------------- | ------------------------ |
| s/S在owner的x位置 | 4   | set UID (SUID) | binary file              |
| s/S在group的x位置 | 2   | set GID (GUID) | binary file or directory |
| t/T在other的x位置 | 1   | Sticky Bit     | directory                |

範例
| rwx 權 限 | octa |
| ----------| ---- |
| rwsr-xr-x | 4755 |
| rwxrwsr-x | 2775 |
| rwxrws--T | 3770 |
| rwxrwxrwt | 1777 |

#### 特殊權限意義

-   SUID
    -   程式對程式有執行權限的使用者,執行程式時的權限與擁有者相同
-   SGID
    -   程式對程式有執行權限的使用者,執行程式時的權限與擁有者相同
    -   目錄下所建立的檔案目錄,其他group成員將與此SGID目錄的group相同
    -   如果沒有SGID權限的情況  
        在目錄下建立目錄時  
        擁有者群組將與建立目錄使用者的使用者群組相同
-   Sticky Bit
    -   該目錄下的檔案目錄只有owner自己才能刪除/移動/改名

#### 權限的判斷順位

1. 是否爲擁有者
2. 是否爲擁有群組成員
3. 其他

#### SUID 範例程式 passwd

這個檔案具有特殊存取權限
`/usr/bin/passwd`
可以看到他的權限是 rws-r-xr-x
表示在執行程式的時候可以暫時取得與擁有者相同的權限
可以修改密碼
異動到`/etc/shadow`這個檔案裏面
shadow 這個檔案的權限是`---------`
儲存加密過的密碼,誰都不能動
不過可以使用root查看內容

#### SGID 範例

除了跟 SUID 雷同之外
目錄的執行權限就是開啓此目錄的權限

#### stick bit 範例資料夾 /tmp

只有擁有者有權限刪除/移動/改名
`/tmp` 目錄的權限 rwxrwxrwt

### 練習4

幫公司兩部門規劃存取權限

1. 業務部存取目錄爲dir1, 會計部爲dir2

```sh
# 先建立所有使用者的共享目錄
mkdir /share
cd /share
mkdir dir1 dir2

# 建立部門群組
# 業務部門
groupadd sales_gp
# 會計部門
groupadd acc_gp

# 通常規劃權限不會去動user,只會動group
# chwon :sales_gp /share/dir1
# chwon :acc_gp /share/dir2
chgrp sales_gp /share/dir1
chgrp acc_gp /share/dir2
```

2. 業務部成員爲 a1、a2、a3, 會計部爲b1、b2、b3

```sh
# 建立群組成員
# 建立使用者的時候,不要去動他的主要群組
# 每個人應該擁有他建立自己資料的權限
useradd a1
useradd a2
useradd a3
useradd b1
useradd b2
useradd b3
useradd c1
useradd c2
useradd c3
# 密碼就不用設定了, 直接用su切換
# 要切回root記得用exit或logout
# 把user新增到群組
vim /etc/group
# 把a1,a2,a3加到sales_gp後面
# 把b1,b2,b3加到acc_gp後面
```

```sh
#!/bin/bash
# 一次建立大量使用者: a1,a2,a3,b1,b2,b3,c1,c2,c3
# Define the prefixes and suffixes
prefixes=("a" "b" "c")
suffixes=("1" "2" "3")
# Loop through the prefixes
for prefix in "${prefixes[@]}"; do
    # Loop through the suffixes
    for suffix in "${suffixes[@]}"; do
        # Create the username by combining prefix and suffix
        username="${prefix}${suffix}"
        # Add the user
        sudo useradd "$username"
        echo "User $username created."
    done
done
```

3. 規劃各部門目錄只有該部門成員具最大存取權限,非部門人員不具任何權限

```sh
chmod -Rv 770 /share/dir*
# 加上特殊權限
chmod -Rv 2770 /share/dir*
```

4. 另外規劃 c1,c2,c3 對兩目錄具唯讀權限

```sh
chmod -Rv 2774 /share/dir*
```

### 實作練習

1. 建立 test1、 test2 帳號 及 mygrp 群組, 此兩帳號以 mygrp作爲附屬群組

```sh
groupadd mygrp
useradd test1
useradd test2
vim /etc/group
# 找到mygrp, 後面加上test1,test2
```

2. 於 `/tmp` 中建立 mydir 目錄, 並將該目錄之擁有群組改成 mygrp

```sh
cd /tmp
mkdir mydir
# 只改group的情況,這兩個指令都可以
chown :mygrp mydir/
chgrp mygrp mydir/
```

3. 讓 `user/group` 對 mydir 具所有權限, others 不具任何權限

```sh
chmod -Rv 770 mydir/
```

4. 於 mydir 目錄中所建檔案目錄, 其擁有群組皆爲 mygrp

```sh
chmod -Rv 2770 mydir/
```

5. mydir 目錄下之檔案目錄, 只有擁有者本身有權限執行 刪除/ 移動/ 改名

```sh
chmod -Rv 3770 mydir/
```

權限會變成 `rwxrws--T`

6. 分別以 root 及 mygrp 群組成員進行測試

## ACL (Access Contol List) 存取控制表 存取控制清單

可以提供額外權限給額外使用者及群組
對目錄預設ACL，可以規劃其下*新*檔案及目錄之權限

basic acl 跟不使用 acl 去設定的權限相同
extended acl 才是這裏要介紹的

### getfacl 查閱檔案目錄的 ACL 權限設定

get file acl

`getacl [OPTION] file ...`

用getacl查看的內容如下

```
# file: acldir      # 檔案名稱
# owner: root       # 檔案擁有者
# group: root       # 檔案擁有群組
user::rwx           # basic acl of owner
user:username:r-x   # extend acl of named user
group::rwx          # basic acl of group
group:groupname:r-x # extend acl of named group
other::rwx          # basic acl of other
```

### setacl 設定檔案目錄的 ACL 權限

set file acl

`setacl [-b] [{-m||-x}] acl_entries] file ...`

參數

-   `-m` 設定檔案目錄的 ACL 記錄
-   `-x` 移除檔案目錄的 ACL 記錄
-   `-b` 移除檔案目錄的所有 extend ACL 記錄
-   `-R` 遞迴設定檔案目錄的 ACL 記錄

不要用ACL指令去動本來的擁有者&擁有群組

### 練習

```sh
# 以root登入
mkdir /acldir
# 查看acldir的傳統權限
ls -ld /acldir
# drwxr-xr-x. 2 root root 6 Apr 30 13:22 acldir
# 查看extend acl
getfacl /acldir

```

預設內容如下

```
# file: acldir # 檔案名稱
# owner: root  # 檔案擁有者
# group: root  # 檔案擁有群組
user::rwx      # basic acl of user
group::r-x     # basic acl of group
other::r-x     # basic acl of other
```

```sh
# 新增群組
groupadd aclgrp
# 新增使用者並加入aclgrp群組
useradd -G aclgrp student01
# 查看aclgrp群組的使用者
getent group aclgrp

# 這裏切換到 student01 測試
su student01
ll /acldir
cd /acldir
touch file01
# 權限不足
mkdir dir01
# 權限不足
# 切回root
exit

# 設定 aclgrp 群組對 /aclgrp 目錄具備 rwx, other 則無任何存取權限
setacl -m g:aclgrp:rwx,o::- /acldir
# 權限也可以用8進位數字
# username 也可以用 userid
# groupname 也可以用 groupid
# 兩個:號中間每寫,就是指本來的擁有者/擁有群組/other
setacl -m g:aclgrp:7,o::0 /acldir
# 設定過權限之後,用ll看到的長格式權限變成mask了,會不準
ls -ld acldir
# drwxrwx---+ 2 root root 6 Apr 30 13:31 /acldir/
# 這裏看到的 + 表示有 extended acl
# 要用 -b 指令移除所有 extended acl 後才會消失
# 設定擁有群組對 /acldir 無任何存取權限
setacl -m g::0 /acldir
# 設定使用者 hydra 對 /acldir 目錄具備rx權限
setacl -m u:hydra:5 /acldir
# 移除權限
setacl -x u:hydra,g:aclgrp /acldir
```
